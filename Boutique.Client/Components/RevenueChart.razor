@using Boutique.Client.Services
@inject AnalyticsService AnalyticsService
@inject IJSRuntime JSRuntime

<div class="chart-container">
    <div class="chart-header">
        <h5 class="chart-title">Revenue Trends</h5>
        <div class="chart-controls">
            <select class="form-select form-select-sm" @onchange="OnMonthsChanged">
                <option value="3">Last 3 Months</option>
                <option value="6" selected>Last 6 Months</option>
                <option value="12">Last 12 Months</option>
            </select>
        </div>
    </div>
    <div class="chart-wrapper">
        <canvas id="revenueChart" width="400" height="200"></canvas>
    </div>
</div>

<style>
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-title {
        margin: 0;
        color: #1f2937;
        font-weight: 600;
    }

    .chart-controls select {
        min-width: 150px;
    }

    .chart-wrapper {
        position: relative;
        height: 300px;
    }

    .dark-theme .chart-container {
        background: #2d3748;
        border-color: #4a5568;
    }

    .dark-theme .chart-title {
        color: #e2e8f0;
    }
</style>

@code {
    private int selectedMonths = 6;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadChart();
        }
    }

    private async Task OnMonthsChanged(ChangeEventArgs e)
    {
        selectedMonths = int.Parse(e.Value?.ToString() ?? "6");
        await LoadChart();
    }

    private async Task LoadChart()
    {
        try
        {
            var chartData = await AnalyticsService.GetRevenueChartDataAsync();
            
            await JSRuntime.InvokeVoidAsync("createRevenueChart", new
            {
                labels = chartData.Labels,
                revenue = chartData.Data,
                orders = chartData.Data.Select((_, i) => i + 1).ToArray() // Sample order counts
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chart: {ex.Message}");
            // Fallback to sample data
            await JSRuntime.InvokeVoidAsync("createRevenueChart", new
            {
                labels = new[] { "Jan", "Feb", "Mar", "Apr", "May", "Jun" },
                revenue = new[] { 12000, 19000, 15000, 25000, 22000, 30000 },
                orders = new[] { 5, 8, 6, 12, 10, 15 }
            });
        }
    }
}

<script>
    window.createRevenueChart = (data) => {
        const ctx = document.getElementById('revenueChart');
        if (!ctx) return;

        // Destroy existing chart if it exists
        if (window.revenueChartInstance) {
            window.revenueChartInstance.destroy();
        }

        window.revenueChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Revenue (₹)',
                    data: data.revenue,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: 'Orders',
                    data: data.orders,
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Revenue (₹)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Orders'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Revenue: ₹' + context.parsed.y.toLocaleString();
                                } else {
                                    return 'Orders: ' + context.parsed.y;
                                }
                            }
                        }
                    }
                }
            }
        });
    };
</script>