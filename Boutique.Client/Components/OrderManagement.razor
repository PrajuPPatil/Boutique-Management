
@using Boutique.Client.Services
@inject OrderService OrderService
@inject CustomerService CustomerService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="container-fluid">
    <!-- Order Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <Boutique.Client.Components.OrderDashboard @ref="orderDashboard" />
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Order Management</h4>
                    <button class="btn btn-primary" @onclick="ShowCreateOrderModal">
                        <i class="fas fa-plus"></i> New Order
                    </button>
                </div>
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" @bind="filterStatus" @bind:after="FilterOrders">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="InProgress">In Progress</option>
                                <option value="ReadyForDelivery">Ready for Delivery</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Partial">Partial</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" @bind="filterPriority" @bind:after="FilterOrders">
                                <option value="">All Priority</option>
                                <option value="Regular">Regular</option>
                                <option value="Urgent">Urgent</option>
                                <option value="Express">Express</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary" @onclick="LoadActiveOrders">Active Orders Only</button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary" @onclick="LoadAllOrders">All Orders</button>
                        </div>
                    </div>

                    <!-- Orders Table -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Order Date</th>
                                    <th>Est. Delivery</th>
                                    <th>Amount</th>
                                    <th>Remaining</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (orders.Any())
                                {
                                    @foreach (var order in orders)
                                    {
                                        <tr>
                                            <td>@order.OrderId</td>
                                            <td>@order.CustomerName</td>
                                            <td>@order.TypeName</td>
                                            <td>
                                                <span class="badge @GetStatusBadgeClass(order.Status)">
                                                    @order.Status
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge @GetPriorityBadgeClass(order.Priority)">
                                                    @order.Priority
                                                </span>
                                            </td>
                                            <td>@order.OrderDate.ToString("dd/MM/yyyy")</td>
                                            <td>@order.EstimatedDeliveryDate.ToString("dd/MM/yyyy")</td>
                                            <td>₹@order.TotalAmount</td>
                                            <td>₹@order.RemainingAmount</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ViewOrder(order)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-success" @onclick="() => ShowStatusModal(order)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="10" class="text-center">No orders found</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
@if (showCreateModal)
{
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Order</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Customer</label>
                        <select class="form-select" @bind="newOrder.CustomerId">
                            <option value="0">Select Customer</option>
                            @foreach (var customer in customers)
                            {
                                <option value="@customer.CustomerId">@customer.CustomerName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Measurement ID (Optional)</label>
                        <input type="number" class="form-control" @bind="newOrder.MeasurementId" placeholder="Leave empty if no measurement" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" @bind="newOrder.Priority">
                            <option value="Regular">Regular (14 days)</option>
                            <option value="Urgent">Urgent (7 days)</option>
                            <option value="Express">Express (3 days)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Total Amount</label>
                        <input type="number" step="0.01" class="form-control" @bind="newOrder.TotalAmount" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" @bind="newOrder.Notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCreateModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateOrder">Create Order</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Status Update Modal -->
@if (showStatusModal)
{
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Order Status</h5>
                    <button type="button" class="btn-close" @onclick="CloseStatusModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Order ID: @selectedOrder?.OrderId</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer: @selectedOrder?.CustomerName</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Status: @selectedOrder?.Status</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Status</label>
                        <select class="form-select" @bind="newStatus">
                            <option value="Pending">Pending</option>
                            <option value="InProgress">In Progress</option>
                            <option value="ReadyForDelivery">Ready for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Partial">Partial</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseStatusModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="UpdateOrderStatus">Update Status</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<OrderDto> orders = new();
    private List<CustomerDto> customers = new();
    private bool showCreateModal = false;
    private CreateOrderDto newOrder = new() { MeasurementId = null };
    private string filterStatus = "";
    private string filterPriority = "";
    private Boutique.Client.Components.OrderDashboard? orderDashboard;
    private bool showStatusModal = false;
    private OrderDto? selectedOrder;
    private string newStatus = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadAllOrders();
        await LoadCustomers();
    }

    private async Task LoadAllOrders()
    {
        orders = await OrderService.GetAllOrdersAsync();
    }

    private async Task LoadActiveOrders()
    {
        orders = await OrderService.GetActiveOrdersAsync();
    }

    private async Task LoadCustomers()
    {
        customers = await CustomerService.GetCustomersAsync() ?? new List<CustomerDto>();
    }

    private async Task FilterOrders()
    {
        var filter = new OrderFilterDto
        {
            Status = string.IsNullOrEmpty(filterStatus) ? null : filterStatus,
            Priority = string.IsNullOrEmpty(filterPriority) ? null : filterPriority
        };
        orders = await OrderService.GetFilteredOrdersAsync(filter);
    }

    private void ShowCreateOrderModal()
    {
        newOrder = new CreateOrderDto { MeasurementId = null };
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
    }

    private async Task CreateOrder()
    {
        try
        {
            if (newOrder.CustomerId <= 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please select a customer");
                return;
            }
            
            if (newOrder.MeasurementId.HasValue && newOrder.MeasurementId <= 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please enter a valid measurement ID");
                return;
            }
            
            if (newOrder.TotalAmount <= 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please enter a valid total amount");
                return;
            }

            Console.WriteLine($"Creating order: Customer={newOrder.CustomerId}, Measurement={newOrder.MeasurementId?.ToString() ?? "None"}, Amount={newOrder.TotalAmount}");
            
            var created = await OrderService.CreateOrderAsync(newOrder);
            if (created != null)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Order created successfully!");
                CloseCreateModal();
                await LoadAllOrders();
                
                // Refresh the order dashboard
                if (orderDashboard != null)
                {
                    await orderDashboard.RefreshAsync();
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to create order. Please check the console for errors.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in CreateOrder: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error creating order: {ex.Message}");
        }
    }

    private void ViewOrder(OrderDto order)
    {
        // Navigate to order details or show modal
    }

    private void ShowStatusModal(OrderDto order)
    {
        selectedOrder = order;
        newStatus = order.Status;
        showStatusModal = true;
    }

    private void CloseStatusModal()
    {
        showStatusModal = false;
        selectedOrder = null;
        newStatus = "";
    }

    private async Task UpdateOrderStatus()
    {
        if (selectedOrder == null || string.IsNullOrEmpty(newStatus))
            return;

        try
        {
            var updateDto = new UpdateOrderStatusDto { Status = newStatus };
            var success = await OrderService.UpdateOrderStatusAsync(selectedOrder.OrderId, updateDto);
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Status updated successfully!");
                CloseStatusModal();
                await LoadAllOrders();
                
                // Refresh the order dashboard statistics
                if (orderDashboard != null)
                {
                    await orderDashboard.RefreshAsync();
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to update status. Please try again.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating status: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error updating status: {ex.Message}");
        }
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Pending" => "bg-warning",
        "InProgress" => "bg-info",
        "ReadyForDelivery" => "bg-success",
        "Delivered" => "bg-secondary",
        "Partial" => "bg-primary",
        _ => "bg-light text-dark"
    };

    private string GetPriorityBadgeClass(string priority) => priority switch
    {
        "Express" => "bg-danger",
        "Urgent" => "bg-warning",
        "Regular" => "bg-primary",
        _ => "bg-light text-dark"
    };
}