@page "/analytics"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Boutique.Client.Services
@using Boutique.Client.Models.DTOs
@using AnalyticsDto = Boutique.Client.Models.DTOs
@inject AnalyticsService AnalyticsService
@inject ExportService ExportService

<div class="analytics-container">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header text-center mb-4">
            <h1 class="page-title">
                <i class="fas fa-chart-bar me-3"></i>Business Analytics
            </h1>
            <p class="page-subtitle">
                Comprehensive insights into your boutique performance
            </p>
        </div>

        @if (isLoading)
        {
            <div class="text-center p-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                <p class="mt-3">Loading analytics data...</p>
            </div>
        }
        else
        {
            <!-- Dashboard Metrics -->
            <div class="row g-3 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="metric-icon bg-primary">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div class="metric-content">
                            <h3>₹@dashboardMetrics?.TotalRevenue.ToString("N0")</h3>
                            <p>Total Revenue</p>
                            <small class="text-success">
                                <i class="fas fa-arrow-up"></i> @dashboardMetrics?.RevenueGrowth.ToString("F1")%
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="metric-icon bg-success">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="metric-content">
                            <h3>@dashboardMetrics?.TotalOrders</h3>
                            <p>Total Orders</p>
                            <small class="text-success">
                                <i class="fas fa-arrow-up"></i> @dashboardMetrics?.OrderGrowth.ToString("F1")%
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="metric-icon bg-info">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="metric-content">
                            <h3>@dashboardMetrics?.TotalCustomers</h3>
                            <p>Total Customers</p>
                            <small class="text-success">
                                <i class="fas fa-arrow-up"></i> @dashboardMetrics?.CustomerGrowth.ToString("F1")%
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="metric-icon bg-warning">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="metric-content">
                            <h3>@dashboardMetrics?.CompletionRate.ToString("F1")%</h3>
                            <p>Completion Rate</p>
                            <small class="text-muted">Order completion</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-3 mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line me-2"></i>Revenue Trends</h5>
                        </div>
                        <div class="card-body">
                            <Boutique.Client.Components.RevenueChart />
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <Boutique.Client.Components.CustomerAnalyticsChart />
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <Boutique.Client.Components.PerformanceMetrics />
                </div>
            </div>

            <!-- Export Options -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-download me-2"></i>Export & Reports</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <button class="btn btn-outline-success w-100" @onclick="ExportToExcel">
                                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-danger w-100" @onclick="ExportToPdf">
                                        <i class="fas fa-file-pdf me-2"></i>Export to PDF
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-primary w-100" @onclick="GenerateReceipt">
                                        <i class="fas fa-receipt me-2"></i>Generate Receipt
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-warning w-100" @onclick="BackupData">
                                        <i class="fas fa-database me-2"></i>Backup Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Analytics -->
            <div class="row g-3 mb-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-star me-2"></i>Top Customers</h5>
                        </div>
                        <div class="card-body">
                            @if (customerAnalytics?.TopCustomers?.Any() == true)
                            {
                                <div class="top-customers-list">
                                    @foreach (var customer in customerAnalytics.TopCustomers.Take(5))
                                    {
                                        <div class="customer-item">
                                            <div class="customer-avatar">
                                                @customer.CustomerName.Substring(0, 1).ToUpper()
                                            </div>
                                            <div class="customer-info">
                                                <div class="customer-name">@customer.CustomerName</div>
                                                <div class="customer-orders">@customer.TotalOrders orders</div>
                                            </div>
                                            <div class="customer-revenue">
                                                ₹@customer.TotalRevenue.ToString("N0")
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center p-3">
                                    <i class="fas fa-users text-muted" style="font-size: 2rem;"></i>
                                    <p class="mt-2 text-muted">No customer data available</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-tachometer-alt me-2"></i>Performance Metrics</h5>
                        </div>
                        <div class="card-body">
                            @if (performanceMetrics != null)
                            {
                                <div class="performance-metrics">
                                    <div class="metric-row">
                                        <span class="metric-label">Average Processing Time</span>
                                        <span class="metric-value">@performanceMetrics.AverageProcessingTime.ToString("F1") days</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">On-Time Delivery Rate</span>
                                        <span class="metric-value">@performanceMetrics.OnTimeDeliveryRate.ToString("F1")%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Customer Satisfaction</span>
                                        <span class="metric-value">@performanceMetrics.CustomerSatisfactionRate.ToString("F1")%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Order Completion Rate</span>
                                        <span class="metric-value">@performanceMetrics.OrderCompletionRate.ToString("F1")%</span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="text-center p-3">
                                    <i class="fas fa-chart-bar text-muted" style="font-size: 2rem;"></i>
                                    <p class="mt-2 text-muted">No performance data available</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .analytics-container {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: #6b7280;
        font-size: 1.1rem;
    }

    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(99, 102, 241, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 50px rgba(99, 102, 241, 0.15);
    }

    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .metric-content h3 {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }

    .metric-content p {
        color: #6b7280;
        margin: 0.25rem 0;
        font-weight: 500;
    }

    .card {
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(99, 102, 241, 0.12);
    }

    .card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        padding: 1rem 1.5rem;
        border-radius: 12px 12px 0 0 !important;
    }

    .card-header h5 {
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }

    .top-customers-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .customer-item {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        transition: all 0.3s ease;
    }

    .customer-item:hover {
        background: rgba(99, 102, 241, 0.05);
        border-radius: 8px;
        padding-left: 1rem;
    }

    .customer-item:last-child {
        border-bottom: none;
    }

    .customer-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        margin-right: 1rem;
    }

    .customer-info {
        flex: 1;
    }

    .customer-name {
        font-weight: 600;
        color: #1f2937;
    }

    .customer-orders {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .customer-revenue {
        font-weight: 700;
        color: #059669;
    }

    .performance-metrics {
        space-y: 1rem;
    }

    .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(99, 102, 241, 0.1);
    }

    .metric-row:last-child {
        border-bottom: none;
    }

    .metric-label {
        color: #6b7280;
        font-weight: 500;
    }

    .metric-value {
        font-weight: 700;
        color: #1f2937;
    }

    .bg-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
    .bg-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important; }
    .bg-info { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%) !important; }
    .bg-warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%) !important; }
</style>

@code {
    private bool isLoading = true;
    private AnalyticsDto.DashboardMetricsDto? dashboardMetrics;
    private AnalyticsDto.CustomerAnalyticsDto? customerAnalytics;
    private AnalyticsDto.PerformanceMetricsDto? performanceMetrics;

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalyticsData();
    }

    private async Task LoadAnalyticsData()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            // Load real-time data from API
            var apiDashboard = await AnalyticsService.GetDashboardMetricsAsync();
            var apiCustomer = await AnalyticsService.GetCustomerAnalyticsAsync();
            var apiPerformance = await AnalyticsService.GetPerformanceMetricsAsync();

            // Map API data to local DTOs
            dashboardMetrics = new AnalyticsDto.DashboardMetricsDto
            {
                TotalRevenue = apiDashboard.TotalRevenue,
                TotalOrders = apiDashboard.TotalOrders,
                TotalCustomers = apiDashboard.TotalCustomers,
                RevenueGrowth = (decimal)apiDashboard.RevenueGrowth,
                OrderGrowth = (decimal)apiDashboard.OrderGrowth,
                CustomerGrowth = (decimal)apiDashboard.CustomerGrowth,
                CompletionRate = 95.0m // Default completion rate
            };

            customerAnalytics = new AnalyticsDto.CustomerAnalyticsDto
            {
                GenderDistribution = apiCustomer.CustomersByGender,
                TopCustomers = apiCustomer.TopCustomers.Select(c => new AnalyticsDto.TopCustomerDto
                {
                    CustomerName = c.CustomerName,
                    TotalOrders = c.OrderCount,
                    TotalRevenue = c.TotalSpent
                }).ToList()
            };

            performanceMetrics = new AnalyticsDto.PerformanceMetricsDto
            {
                AverageProcessingTime = apiPerformance.AverageOrderProcessingTime,
                OnTimeDeliveryRate = (decimal)apiPerformance.CustomerSatisfactionRate,
                CustomerSatisfactionRate = (decimal)apiPerformance.CustomerSatisfactionRate,
                OrderCompletionRate = (decimal)apiPerformance.OrderCompletionRate
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading analytics data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ExportToExcel()
    {
        var exportData = new List<object>
        {
            new { Metric = "Total Revenue", Value = dashboardMetrics?.TotalRevenue ?? 0 },
            new { Metric = "Total Orders", Value = dashboardMetrics?.TotalOrders ?? 0 },
            new { Metric = "Total Customers", Value = dashboardMetrics?.TotalCustomers ?? 0 }
        };
        await ExportService.ExportToExcelAsync(exportData, "Analytics_Report");
    }

    private async Task ExportToPdf()
    {
        var content = $"<h1>Analytics Report</h1><p>Total Revenue: ₹{dashboardMetrics?.TotalRevenue ?? 0}</p>";
        await ExportService.ExportToPdfAsync(content, "Analytics_Report");
    }

    private async Task GenerateReceipt()
    {
        var receipt = new { id = 1, customerName = "Sample Customer", amount = 1000, paymentMethod = "Cash" };
        await ExportService.GenerateReceiptPdfAsync(receipt, "Receipt");
    }

    private async Task BackupData()
    {
        await ExportService.BackupDataAsync();
    }
}